<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Eth-Infinity-Playground â€” WalletConnect (Web3)</title>
<style>
  :root{--bg1:#0b1730;--bg2:#0ea5e9;--card:rgba(255,255,255,0.04)}
  body{margin:0;font-family:Inter,Arial,sans-serif;background:linear-gradient(135deg,var(--bg1),#082032);color:#e6f7ff}
  header{padding:18px;text-align:center}
  .lead{opacity:.9;margin-top:6px}
  .top{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap}
  .btn{background:#06b6d4;border:none;padding:10px 14px;border-radius:10px;color:#042;cursor:pointer;font-weight:700}
  .addr{font-family:monospace;background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:8px}
  main{max-width:1200px;margin:20px auto;padding:0 12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px}
  .card{background:var(--card);padding:14px;border-radius:12px}
  input,textarea{width:100%;padding:8px;border-radius:8px;border:none;margin-top:6px;box-sizing:border-box}
  .callBtn{background:#fb923c;border:none;padding:8px 10px;border-radius:8px;color:#fff;cursor:pointer;margin-top:8px}
  .status{margin-top:8px;font-size:13px;color:#bfffcf;min-height:18px}
  footer{padding:18px;text-align:center;opacity:0.9}
  a.link{color:#ffd;text-decoration:none;font-size:13px}
</style>
</head>
<body>

<header>
  <h1>ðŸŒŒ Eth-Infinity-Playground</h1>
  <div class="lead">WalletConnect + MetaMask (Web3). Click Connect â†’ then use cards to call on-chain functions.</div>
  <div class="top" style="margin-top:10px">
    <button id="btnConnect" class="btn">ðŸ”— Connect Wallet</button>
    <div id="addr" class="addr">Not connected</div>
    <div id="chain" class="addr" style="display:none"></div>
  </div>
</header>

<main>
  <div id="grid" class="grid"></div>
  <div style="font-size:13px;margin-top:12px;opacity:0.9">If a call fails because the ABI differs, open the contract's BaseScan Write page.</div>
</main>

<footer>
  Repo: <code>Eth-infinity-playground</code> â€” Live: <a class="link" href="https://ordiha.github.io/Eth-infinity-playground/" target="_blank">/Eth-infinity-playground/</a>
</footer>

<!-- libs (UMD) -->
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

<script>
/*
  Drop-in WalletConnect/Web3 front.
  - Will use abis.js in repo if present (global "abis" or "abisObj"). Otherwise uses embedded fallbackContracts below.
  - WalletConnect provider infuraId: tries legacy ID used earlier if none provided.
*/
const LEGACY_INFURA_ID = "5056a2b581e5962f9e3083d68053b5d8"; // used in working dapp before
let web3, provider, accounts;

// fallback contracts (minimal functions) â€” includes your main deployed addresses you provided
const fallbackContracts = [
  { name:"OpenMintNFT", addr:"0x79f6e18a8376b02b35C1D5C02DA86Ec03cA6d57d", funcs:[{name:"mint", inputs:[{name:"_text",type:"string"}], type:"tx"}] },
  { name:"ColorNFT", addr:"0x7e5b2523Da5D63e500b9b050f45f993b811c6548", funcs:[{name:"mint", inputs:[{name:"color",type:"string"}], type:"tx"}] },
  { name:"TimeNFT", addr:"0x6A7b0FD9Ea1809a5F0F4369e191a0B021D11BCD5", funcs:[{name:"mint", inputs:[], type:"tx"}] },
  { name:"GiveawayNFT", addr:"0xF3b6f93110e308Acc02f70E36F9F031731f7f5E7", funcs:[{name:"giveawayMint", inputs:[{name:"recipients",type:"address[]"}],type:"tx"}] },
  { name:"DonationTracker2", addr:"0x9dDAf52D93FE53715dC510190b2DDD1d1CafA8fB", funcs:[{name:"donate",inputs:[],type:"tx",payable:true},{name:"contractBalance",inputs:[],type:"call"}] },
  { name:"Lottery", addr:"0x2eDb3668A8c37a1b1D1934e4247da47FA2c73daf", funcs:[{name:"buyTicket",inputs:[],type:"tx",payable:true}] },
  { name:"OpinionRegistry", addr:"0xE74706982Be1c7223E5855EA42DCF96F1104215B", funcs:[{name:"addOpinion",inputs:[{name:"_text",type:"string"}],type:"tx"},{name:"totalOpinions",inputs:[],type:"call"}] },
  { name:"GuessNumber", addr:"0xe5c4636C0249312fda74492A1a68094C1c08dA54", funcs:[{name:"guess",inputs:[{name:"_g",type:"uint256"}],type:"tx"}] }
  // add more if you want â€” abis.js will override if present
];

// read abis.js if present (global "abis" object). This file will accept abis variable with structure: {Name:{address:"0x...",abi:[...]}}
// Many of your repos used an "abis" object. We'll try to convert that into our expected list.
function loadContractsFromAbisGlobal() {
  try {
    if (typeof abis !== "undefined" && abis && Object.keys(abis).length>0) {
      const list = [];
      for (const [k,v] of Object.entries(abis)) {
        const funcs = [];
        if (Array.isArray(v.abi)) {
          v.abi.forEach(item => {
            if (item.type === "function") {
              const inputs = (item.inputs||[]).map(i=>({name:i.name,type:i.type}));
              const ftype = (item.stateMutability==="view"||item.stateMutability==="pure") ? "call" : "tx";
              funcs.push({ name:item.name, inputs, type:ftype, payable: item.stateMutability==="payable" });
            }
          });
        }
        list.push({ name:k, addr:v.address||v.address||"", funcs });
      }
      return list;
    }
  } catch(e) { console.warn("load abis failed", e); }
  return null;
}

const contractList = loadContractsFromAbisGlobal() || fallbackContracts;

/* ===== UI rendering ===== */
function buildUI() {
  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  contractList.forEach(c => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<h3>${c.name}</h3><div style="font-size:13px;opacity:.9">${c.addr}</div><div id="controls-${c.name}"></div><div class="status" id="status-${c.name}"></div>
      <a class="link" href="https://basescan.org/address/${c.addr}#code" target="_blank">View on BaseScan</a>`;
    grid.appendChild(card);
    const controls = document.getElementById(`controls-${c.name}`);
    (c.funcs||[]).forEach(fn=>{
      const block = document.createElement("div");
      block.style.marginTop = "8px";
      // inputs
      (fn.inputs||[]).forEach(inp=>{
        const inpEl = document.createElement("input");
        inpEl.placeholder = inp.type.includes("address[]") ? `${inp.name} (comma addresses)` :
                             inp.type.includes("address") ? `${inp.name} (address)` :
                             inp.type.includes("uint") ? `${inp.name} (number)` :
                             `${inp.name} (${inp.type})`;
        inpEl.id = `${c.name}_${fn.name}_${inp.name}`;
        inpEl.type = inp.type.includes("uint") ? "number" : "text";
        block.appendChild(inpEl);
      });
      // payable amount field
      if (fn.payable) {
        const amt = document.createElement("input");
        amt.placeholder = "ETH amount (e.g. 0.001)";
        amt.id = `${c.name}_${fn.name}_value`;
        amt.type = "number";
        amt.step = "0.000000001";
        block.appendChild(amt);
      }
      const btn = document.createElement("button");
      btn.className = "callBtn";
      btn.innerText = fn.type==="call" ? `Call ${fn.name}` : `Send ${fn.name}`;
      btn.onclick = ()=>invoke(c,fn);
      block.appendChild(btn);
      controls.appendChild(block);
    });
  });
}

/* ===== Connect handling ===== */
async function connect() {
  try {
    // prefer extension
    if (window.ethereum) {
      provider = window.ethereum;
      await provider.request({ method: "eth_requestAccounts" });
      web3 = new Web3(provider);
      accounts = await web3.eth.getAccounts();
      setConnected(accounts[0]);
      return;
    }

    // fallback WalletConnect (UMD v1)
    const WalletConnectProvider = window.WalletConnectProvider.default;
    provider = new WalletConnectProvider({
      infuraId: LEGACY_INFURA_ID
    });
    await provider.enable();
    web3 = new Web3(provider);
    accounts = await web3.eth.getAccounts();
    setConnected(accounts[0]);
  } catch (err) {
    console.error("connect error", err);
    alert("Connect failed: " + (err.message||err));
  }
}

function setConnected(addr) {
  document.getElementById("addr").innerText = addr || "Unknown";
  document.getElementById("chain").style.display = "inline-block";
  document.getElementById("chain").innerText = "Connected";
  // provider events
  provider && provider.on && provider.on("accountsChanged",(accs)=> {
    document.getElementById("addr").innerText = accs[0]||"Not connected";
  });
}

document.getElementById("btnConnect").onclick = connect;

/* ===== invoke contract functions (web3) ===== */
async function invoke(contractObj, fn) {
  const statusEl = document.getElementById(`status-${contractObj.name}`);
  statusEl.innerText = "Processing...";
  try {
    if (!web3) return alert("Connect wallet first!");
    if (!contractObj.addr) throw new Error("Contract address missing");

    // build minimal ABI for this single function
    const abi = [{
      name: fn.name,
      type: "function",
      inputs: (fn.inputs||[]).map(i=>({name:i.name,type:i.type})),
      stateMutability: fn.payable ? "payable" : (fn.type==="call" ? "view" : "nonpayable"),
      outputs: fn.type==="call" ? [{type:"string"}] : []
    }];

    const contract = new web3.eth.Contract(abi, contractObj.addr);
    // prepare args
    const args = (fn.inputs||[]).map(i=>{
      const el = document.getElementById(`${contractObj.name}_${fn.name}_${i.name}`);
      let v = el ? el.value : "";
      if (i.type.endsWith("[]")) {
        // parse comma separated
        return v ? v.split(",").map(s=>s.trim()) : [];
      }
      if (i.type.startsWith("uint")) return v? v.toString() : "0";
      return v;
    });

    const from = (accounts && accounts[0]) || (await web3.eth.getAccounts())[0];

    if (fn.type === "call") {
      const res = await contract.methods[fn.name](...args).call({ from });
      statusEl.innerText = `Result: ${JSON.stringify(res)}`;
    } else {
      // payable override
      const valueEl = document.getElementById(`${contractObj.name}_${fn.name}_value`);
      const value = valueEl && valueEl.value ? web3.utils.toWei(valueEl.value.toString(), "ether") : "0";
      const tx = await contract.methods[fn.name](...args).send({ from, value });
      statusEl.innerText = `Tx: ${tx.transactionHash}`;
    }
  } catch (err) {
    console.error("invoke error", err);
    let message = err && err.message ? err.message : String(err);
    // common provider message adjustment for clarity
    if (message.includes("User denied")) message = "User denied signature/tx";
    statusEl.innerText = `Error: ${message}`;
  }
}

/* ===== init ===== */
buildUI();
</script>
</body>
</html>
